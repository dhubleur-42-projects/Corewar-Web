name: Build docker images

on:
    workflow_call:
        inputs:
            buildArgs:
                description: 'Build arguments to pass to docker build (multi-line string, one per line)'
                required: false
                type: string
            tags:
                description: 'Tags to apply to the built images (space-separated)'
                required: true
                type: string
        secrets:
            DOCKER_USERNAME:
                required: true
            DOCKER_PASSWORD:
                required: true

jobs:
    build-common-stage:
        name: Build common-stage image
        runs-on: ubuntu-24.04
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Log in to Docker Registry
              uses: docker/login-action@v3
              with:
                  registry: registry.ozyria.fr
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
              with:
                  driver: docker-container
                  install: true
                  buildkitd-flags: --debug

            - name: Build and push common-stage
              uses: docker/build-push-action@v6
              with:
                  context: ./
                  file: ./Dockerfile
                  push: false
                  target: build
                  platforms: linux/amd64
                  build-args: ${{ inputs.buildArgs }}
                  tags: registry.ozyria.fr/corewar/common-stage:latest
                  cache-from: type=registry,ref=registry.ozyria.fr/corewar/build-cache:shared
                  cache-to: type=registry,ref=registry.ozyria.fr/corewar/build-cache:shared,mode=max

    build-apps:
        name: Build app images
        needs: build-common-stage
        runs-on: ubuntu-24.04
        strategy:
            matrix:
                app:
                    - back-app
                    - migrate-job
                    - exec-app
                    - front-app

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Log in to Docker Registry
              uses: docker/login-action@v3
              with:
                  registry: registry.ozyria.fr
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
              with:
                  driver: docker-container
                  install: true
                  buildkitd-flags: --debug

            - name: Prepare tags
              id: tags
              run: |
                  IMAGE="registry.ozyria.fr/corewar/${{ matrix.app }}"
                  TAGS=()

                  read -ra TAG_ARRAY <<< "${{ inputs.tags }}"

                  for tag in "${TAG_ARRAY[@]}"; do
                    [ -z "$tag" ] && continue
                    TAGS+=("$IMAGE:$tag")
                  done

                  TAG_LIST=$(IFS=, ; echo "${TAGS[*]}")
                  echo "Prepared tags: $TAG_LIST"
                  echo "tags=$TAG_LIST" >> $GITHUB_OUTPUT

            - name: Build and push ${{ matrix.app }} image
              uses: docker/build-push-action@v6
              with:
                  context: ./
                  file: ./Dockerfile
                  push: true
                  target: ${{ matrix.app }}
                  platforms: linux/amd64
                  build-args: ${{ inputs.buildArgs }}
                  tags: ${{ steps.tags.outputs.tags }}
                  cache-from: type=registry,ref=registry.ozyria.fr/corewar/build-cache:shared
                  cache-to: type=registry,ref=registry.ozyria.fr/corewar/build-cache:shared,mode=max
